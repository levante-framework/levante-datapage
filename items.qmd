{{< include _load-data-items.qmd >}}

{{< include components/_interval.qmd >}}
{{< include components/_tol.qmd >}}
{{< include components/_style.qmd >}}

```{ojs prelims}
Plot = import("https://esm.sh/@observablehq/plot@0.6.17")
```

```{ojs items}
items = transpose(items_)
models = transpose(models_)

tasks = d3.group(items, d => d.task_label)
viewof task_items = Inputs.select(tasks, { label: "Task", value: tasks.get("Math") })
item_groups = new Set(task_items.map(d => d.item_group))

item_vars = ["item_group", "item_entry", "item_uid", "difficulty", "n_responses"]
item_channels = Object.fromEntries(item_vars.map(k => [k, k]))

task = task_items[0].task_code
model = models.filter(t => t.task_code === task)[0]
by_lang = model.language !== undefined

heights = ({
  "hf":     140,
  "sds":    200,
  "mg":     180,
  "math":   450,
  "matrix": 180,
  "mrot":   110,
  "trog":   650,
  "vocab":  300,
  "tom":    180,
})
```

```{ojs model-info}
html`<div class="source"><a href="${model.file_link}" target="_blank">Source</a>: ${model.itemtype} IRT model (${model.invariance_label}) fit to ${model.n_runs} runs, uploaded on ${model.added_at_date} to model registry version ${model.registry_version}.</div>`
```

```{ojs difficulty-plot}
Plot.plot({
  style: { fontFamily: "var(--sans-serif)", fontSize: 12 },
  width: 700,
 height: heights[task],
 marginLeft: 110,
   grid: true,
  facet: { label: null, grid: true },
  x: { line: true },
  color: { legend: false, scheme: "viridis" },
  r: {range: [1, 4] },
  marks: [
    Plot.dot(task_items, Plot.dodgeY("middle", {
      x: "difficulty",
      fy: by_lang ? "language" : "item_group",
      fill: by_lang ? "language" : "item_group",
      r: "n_responses",
      sort: {fy: "x", color: "x", reduce: "median"},
      tip: { format: { fy: false }},
      channels: item_channels,
    })),
  ]
})
```

```{ojs discrimination-plot}
model.itemtype === "2PL" ? Plot.plot({
  style: { fontFamily: "var(--sans-serif)", fontSize: 12 },
  width: 700,
 height: heights[task],
 marginLeft: 110,
   grid: true,
  facet: { label: null, grid: true },
  x: { line: true },
  color: { legend: false, scheme: "viridis" },
  r: {range: [1, 4] },
  marks: [
    Plot.dot(task_items, Plot.dodgeY("middle", {
      x: "discrimination",
      fy: by_lang ? "language" : "item_group",
      fill: by_lang ? "language" : "item_group",
      r: "n_responses",
      sort: {fy: "difficulty", color: "difficulty", reduce: "median"},
      tip: { format: { fy: false }},
      channels: item_channels,
    })),
  ]
}) : html`<div></div>`
```
