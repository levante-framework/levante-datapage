{{< include _load-data-overview.qmd >}}
{{< include components/_style.qmd >}}
{{< include components/_tol.qmd >}}

```{ojs prelims}
//| output: false

Plot = import("https://esm.sh/@observablehq/plot@0.6.17")
overview = transpose(overview_)

task_info = ({
    "hf": "Hearts & Flowers",
   "sds": "Same & Different",
    "mg": "Memory",
  "math": "Math",
"matrix": "Pattern Matching",
  "mrot": "Shape Rotation",
  "trog": "Sentence Understanding",
 "vocab": "Vocabulary",
   "tom": "Stories",
    "pa": "Language Sounds",
   "sre": "Sentence Reading",
   "swr": "Word Reading",
})

ov = overview.map(obj => ({...obj, task_label: task_info[obj.task_code]}))
```

:::: {.column-screen-inset}

```{ojs diplay-vals}
displayScheme = [
  [204, 102, 119],
  [221, 204, 119],
  [153, 153,  51],
  [ 68, 170, 153],
  [136, 204, 238],
  [170,  68, 153],
]

displayConfig = ([
  { index: 0, property: "site",         label: "Sites",        icon: "globe"          },
  { index: 1, property: "dataset",      label: "Datasets",     icon: "archive"        },
  { index: 2, property: "language",     label: "Languages",    icon: "translate"      },
  { index: 3, property: "task_code",    label: "Tasks",        icon: "ui-checks-grid" },
  { index: 4, property: "user_id_hash", label: "Participants", icon: "person-arms-up" },
  { index: 5, property: "run_id_hash",  label: "Assessments",  icon: "clipboard-data" },
])

displayBox = ({ index, property, label, icon }) => {
  const values = new Set(ov.map(d => d[property]))
  const color = displayScheme[index]
  const color_str = `${color[0]}, ${color[1]}, ${color[2]}`
  const borderColor = `rgb(${color_str})`
  const backgroundColor = `rgba(${color_str}, 0.4)`
  return html`<div class="callout callout-style-default callout-note no-icon callout-empty-content callout-titled callout-display" style="border-left-color: ${borderColor};">
    <div class="callout-header d-flex align-content-center" style="background-color: ${backgroundColor};">
      <div class="callout-title-container flex-fill">
        <span class="display-box">
          <span class="display-icon"><i class="bi-${icon}" role="img" aria-hidden="true"></i></span>
          <span class="display-content">
            <span class="display-var">${label}</span>
            <span class="display-val">${values.size}</span>
          </span>
        </span>
      </div>
    </div>
  </div>`
}

boxes = displayConfig.map(displayBox)
html`<div class="display-box-container">${boxes}</div>`
```

:::: {layout="[ [1,1] ]"}
::: {.plot-container}
::: {.plot-inputs}

```{ojs}
x_var_opts = new Map([["Assessments", "run_id_hash"], ["Participants", "user_id_hash"]])
viewof x_var = Inputs.select(x_var_opts, { label: "Count of" })
```

```{ojs}
y_var_opts = new Map([["Site", "site"], ["Dataset", "dataset"], ["Language", "language"], ["Task", "task_label"]])
viewof y_var = Inputs.select(y_var_opts, { label: "For each", value: "task_label" })
```

```{ojs}
color_opts = new Map([["", null], ["Site", "site"], ["Dataset", "dataset"], ["Language", "language"], ["Task", "task_label"]])
viewof color_var = Inputs.select(color_opts, { label: "Grouped by", value: "language" })
```

:::

```{ojs}
scheme = tol.QualMuted // color scheme
default_color = scheme[1] // default color when there's no color variable
plt_color = color_var || default_color // plot color variable

x_lab = x_var_opts.entries().filter(([k, v]) => v === x_var)
y_lab = y_var_opts.entries().filter(([k, v]) => v === y_var)

//groups = d3.groupSort(ov, g => -new Set(g.map(d => d[x_var])).size, d => d[color_var])

marginLeft = 160
Plot.plot({
  style: { fontFamily: "var(--sans-serif)", fontSize: 12 },
  width: 0.5 * width,
  marginLeft: marginLeft,
  marginTop: 10,
  marginBottom: 40,
      //x: { grid: true },
  x: { label: `${x_lab[0]} count`, axis: "bottom", line: true },
  y: { label: y_lab[0], labelAnchor: "top", tickSize: 0, tickPadding: 2 },
  color: {
    //domain: groups,
    range: scheme,
    legend: color_var !== null,
    marginLeft: marginLeft,
    className: "color-legend"
  },
  marks: [
    Plot.barX(ov, Plot.groupY(
      { x: g => new Set(g.map(d => d[x_var])).size },
      { y: y_var, fill: plt_color, sort: { y: "x", reverse: true, }, inset: 1 }
    )),
    Plot.textX(ov, Plot.stackX(Plot.groupY(
      { x: g => new Set(g.map(d => d[x_var])).size, text: g => new Set(g.map(d => d[x_var])).size },
      { y: y_var, z: plt_color, fill: "white" }
    ))),
  ]
})
```

:::

::: {.plot-container}

::: {.plot-inputs}

```{ojs}
hist_var_opts = new Map([["Age (years)", "age"]])
viewof hist_var = Inputs.select(hist_var_opts, { label: "Count of" })

//hist_bin_opts = new Map([["Age (years)", "age"]])
//hist_bin_opts = d3.range(1, 24, 1) // months
//viewof hist_bin = Inputs.select(hist_bin_opts, { label: "Binned to" })
```

```{ojs}
stack_var_opts = new Map([["", null], ["Site", "site"], ["Dataset", "dataset"], ["Language", "language"], ["Task", "task_label"]])
viewof stack_var = Inputs.select(stack_var_opts, { label: "Grouped by", value: "language" })
```

:::

```{ojs}
hist_x_lab = hist_var_opts.entries().filter(([k, v]) => v === hist_var)

Plot.plot({
  style: { fontFamily: "var(--sans-serif)", fontSize: 12 },
  //width: 1000,
  width: 0.5 * width,
  height: 300,
  marginTop: 10,
  marginBottom: 40,
  x: {
    //domain: [3,12],
    label: hist_x_lab[0],
    line: true
  },
  color: {
    legend: true,
    label: "bem",
    //domain: groups,
    range: scheme,
    //legend: stack_var !== null,
    //marginLeft: marginLeft,
    className: "color-legend"
  },
  marks: [
    Plot.rectY(ov, Plot.binX({y: "count"}, {
      fill: stack_var || default_color,
      x: {
        //interval: hist_bin / 12,
        value: hist_var
      }
    })),
  ]
})
```

::::
::::
